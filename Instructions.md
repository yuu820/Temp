# English learning system 仕様書

## 1. 目的
- 生成Geminiを利用した英語の長文教材の作成、自由英作文の添削を通して利用者の英語能力を向上させる。

## 2. 使用技術
- HTML / CSS / JavaScript
- React / Node.js
- SQLite3

## 3. 利用者登録
- 管理画面上で管理者がログイン情報を登録する。
- 各利用者に固有のユーザーIDとパスワードを割り当てる。

## 4. 利用者ロール
利用者には以下の4つのロールが割り当てられ、ロールによって機能制限を受ける。

1. アクセス数ロール（1日当たりの生成AIのリクエスト数制限）  
   - 無制限: 制限なし  
   - 制限付き: 管理画面で設定されたアクセス数までのみ利用可能（日本時間0時にリセット）

2. 優先度（レート制限による待機時の優先度）  
   - 優先: 待機列に通常利用者がいる場合、待機列の先頭に移動可能  
   - 通常: 待機列が発生している場合はFIFOで処理

3. 利用者種別  
   - 管理者: 管理画面へのアクセス権を持ち、設定変更が可能  
   - ヘルパー: 管理画面へのアクセス権はあるが設定変更は不可  
   - 一般ユーザー: 管理画面へのアクセス権なし

4. Proアクセス  
   - Proアクセス有り: Gemini 2.5 Proが利用可能  
   - Proアクセス無し: Gemini 2.5 Proは利用不可

## 5. 利用者データベース
- ユーザーID、パスワード、表示名、ロールを管理し、これを基にログイン認証を行う。

## 6. 管理画面
- 利用者情報の登録・変更、レート制限変更、運用情報確認、データベースの確認・変更・削除を提供。  
- 利用者管理、レート制限、運用情報、データベースの各セクションに分割。
- レート制限では2種類のリクエストについて何秒当たり1件通すかを設定し、直近1分間のアクセス超過しきい値も設定可能。
- 運用情報では待ち情報や同時接続数を確認できる。
- 利用者情報やデータベースにソート・検索・並べ替え機能を備える。

## 7. 待機リスト
- レート制限のしきい値超過時にリクエストを待機リストへ投入。
- 問題作成待機リストと問題添削待機リストの2種類があり、行動ごとに振り分ける。
- 各待機リストは管理画面で設定されたレートで処理。
- 両方の待機リストが空になり、かつ1分間のリクエストがしきい値未満になった場合は待機を終了し即時処理する。
- 片方が空で他方に待機がある場合、本来の枠を優先しつつ空き枠で混雑側を処理。

## 8. 長文問題機能
- 長文問題の作成から添削までを提供。
- 問題作成時に語数・難易度・種類・テーマを設定。  
  - 語数: 1000語以下で指定。1000語以上を指定した場合は1000語として扱う。  
  - 難易度: 高校生定期テスト／共通テスト／二次試験初級（地方国立）／二次試験上級（旧帝・難関国立）から選択。  
  - 問題種類: 文法4択、語彙4択、内容一致4択、並び替え、文法記述、語彙記述、日本語訳を問題数指定で作成。  
  - テーマ: 自由入力。入力があればそのテーマで作成。
- 語数・難易度・問題の種類はいずれも必須。未入力なら作成しない。
- 作成した問題数分の回答枠を用意し、各枠に回答する。
- 最終枠下に提出ボタンを配置し、空白の回答枠がなければ添削を実行。
- 提出ボタンと中断ボタンを設置し、ユーザーのcookie等に保存して途中再開を可能にする。
- 添削は内容・要点・文法が適切なら満点を付与し、日本語訳・要点・重要文法事項を表示。
- 問題作成は問題作成待機リスト、添削は問題添削待機リストへ必要に応じて誘導。
- 添削は非同期で行い、ユーザーはタブを開いたまま待つ必要がない。
- 下記タスクデータベースへ登録を行う。

## 9. 自由英作文機能
- テーマを設定して問題を生成。未指定の場合は適当なテーマを用意。
- 指定テーマに基づき問題を作成。
- 添削基準:  
  1) 内容: 課題で求められた内容（意見と理由）が含まれているか  
  2) 構成: 構成がわかりやすく論理的か  
  3) 語彙: 課題に相応しい語彙を正しく使えているか  
  4) 文法: 文構造のバリエーションと適切な使用
- 回答枠右下に入力語数を表示。
- 回答枠下部に添削ボタンを配置し、空白でなければ添削を実行。
- 添削ボタンと中断ボタンを設置し、ユーザーのcookie等に保存して途中再開を可能にする。
- 問題作成は問題作成待機リスト、添削は問題添削待機リストへ必要に応じて誘導。
- 添削は非同期で実行し、タブを開いたまま待つ必要がない。
- 下記タスクデータベースへ登録を行う。

## 10. タスクデータベース
- 長文タスクデータベースと自由英作文タスクデータベースに分割。
- 長文タスクデータベース: タスクID、生成ユーザーID、語数、難易度、問題種類ごとの問題数、テーマ、生成英文、問題、添削、ユーザー回答を記録。
- 自由英作文タスクデータベース: タスクID、ユーザーID、テーマ、ユーザー入力英文、添削を記録。
- タスクIDはタスクごとに一意に割り当てる。

## 11. タスク管理
- 利用者が実施したタスクを一覧表示し、添削確認や解き直しを提供。
- 添削確認: 非同期処理完了後に添削内容を確認。
- 解き直し機能:  
  1) 英語長文と問題をそのまま解き直す  
  2) 英語長文は同じで問題のみ作り替えて解き直す  
  3) 自由英作文で同一問題を解き直す  
  - 解き直し時は新規タスクとして扱い、新しいタスクIDを発行し、必要に応じて問題情報や文章を再登録。
- 再開機能: 中断されたタスクを途中から再開できる。

## 12. 備考
- スマートフォン利用を前提とし、UIが崩れないようにする。
- HTMLタグやJavaScriptコードを回答枠やデータベースに格納してもバグが起きないよう対策する。
